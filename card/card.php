<?php
include 'simple_html_dom.php';
// error_reporting(E_ALL);
// ini_set('display_errors', '1');
  
// //将出错信息输出到一个文本文件
// ini_set('error_log', dirname(__FILE__) . '/error_log.txt');
//输出图像数据
function imagepgm($dst_im) 
{	
	$cmp=array(
			"0"=>"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111100000000000000000011001100000000000000000110011000000000000000011100110000000000000000111001110000000000000001110011100000000000000011100111000000000000000111001110000000000000001110011100000000000000011100111000000000000000011001100000000000000000110011000000000000000000111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
			"1"=>"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000000000000000111100000000000000000000011000000000000000000000110000000000000000000001100000000000000000000011000000000000000000000110000000000000000000001100000000000000000000011000000000000000000000110000000000000000000001100000000000000000000011000000000000000000001111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
			"2"=>"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111100000000000000000110011000000000000000001100111000000000000000000001110000000000000000000011100000000000000000000110000000000000000000001100000000000000000000110000000000000000000011100000000000000000000110000000000000000000011000000000000000000001110011000000000000000011111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
			"3"=>"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111100000000000000000011011100000000000000000100011000000000000000000000110000000000000000000001000000000000000000000110000000000000000000111110000000000000000000001100000000000000000000011100000000000000000000111000000000000000000001100000000000000000110011000000000000000011111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
			"4"=>"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001100000000000000000000111000000000000000000001110000000000000000000111100000000000000000001011000000000000000000110110000000000000000011001100000000000000000110011000000000000000011111111000000000000000000001100000000000000000000011000000000000000000000110000000000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
			"5"=>"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111110000000000000000001000000000000000000000110000000000000000000001000000000000000000000111100000000000000000000011110000000000000000000001100000000000000000000001100000000000000000000011000000000000000000000110000000000000000000001100000000000000001100110000000000000000011111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
			"6"=>"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011100000000000000000001100000000000000000000111000000000000000000001100000000000000000000111000000000000000000001111110000000000000000011000110000000000000000110001100000000000000001100011000000000000000011000110000000000000000110001100000000000000001110011000000000000000001111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
			"7"=>"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111110000000000000000110001100000000000000001000011000000000000000000001100000000000000000000011000000000000000000000110000000000000000000001000000000000000000000110000000000000000000001100000000000000000000011000000000000000000001100000000000000000000011000000000000000000000110000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
			"8"=>"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111100000000000000000110001100000000000000001100011000000000000000011000110000000000000000111011100000000000000000111110000000000000000000111000000000000000000011111000000000000000001100111000000000000000011000110000000000000000110001100000000000000001100011000000000000000001111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
			"9"=>"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111100000000000000000110011000000000000000001100011000000000000000011000110000000000000000110001100000000000000001100011000000000000000011001110000000000000000011111100000000000000000000111000000000000000000001100000000000000000000111000000000000000000001100000000000000000001110000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
			);
	$str="";		
	for($y = 0; $y < imagesy($dst_im); $y++)
	{
	
		for($x = 0; $x < imagesx($dst_im); $x++)
		{
			$colors_reg = imagecolorsforindex($dst_im, imagecolorat($dst_im, $x, $y));
			//var_dump($colors_reg);
			if($colors_reg['red']==0){
				$str .= '1'; 				
			}else{
				$str .= '0'; 				
			}
		}

	}
	if ($cmp!="") {
		foreach ($cmp as $key => $value) {
			if ($value==$str) {
				$str=$key;
			}
		}
	}

	return $str;
}
function get_img($im){	
	$dst_im0 = imagecreatetruecolor(23, 23);
	$dst_im1 = imagecreatetruecolor(23, 23);
	$dst_im2 = imagecreatetruecolor(23, 23);
	$dst_im3 = imagecreatetruecolor(23, 23);
	$dst_im4 = imagecreatetruecolor(23, 23);
	$dst_im5 = imagecreatetruecolor(23, 23);
	$dst_im6 = imagecreatetruecolor(23, 23);
	$dst_im7 = imagecreatetruecolor(23, 23);
	$dst_im8 = imagecreatetruecolor(23, 23);
	$dst_im9 = imagecreatetruecolor(23, 23);

	//源图像
	$src_im = $im;

	//拷贝源图像左上角起始 
	imagecopy( $dst_im0, $src_im, 0,0, 10,36,23,23 );
	imagecopy( $dst_im1, $src_im, 0,0, 46,36,23,23 );
	imagecopy( $dst_im2, $src_im, 0,0, 82,36,23,23 );
	imagecopy( $dst_im3, $src_im, 0,0, 10,72,23,23 );
	imagecopy( $dst_im4, $src_im, 0,0, 46,72,23,23 );
	imagecopy( $dst_im5, $src_im, 0,0, 82,72,23,23 );
	imagecopy( $dst_im6, $src_im, 0,0, 10,108,23,23 );
	imagecopy( $dst_im7, $src_im, 0,0, 46,108,23,23 );
	imagecopy( $dst_im8, $src_im, 0,0, 82,108,23,23 );
	imagecopy( $dst_im9, $src_im, 0,0, 10,144,23,23 );
// echo "<img src='photo_0.png'>";
// echo "<img src='photo_1.png'>";
// echo "<img src='photo_2.png'><br />";
// echo "<img src='photo_3.png'>";
// echo "<img src='photo_4.png'>";
// echo "<img src='photo_5.png'><br />";
// echo "<img src='photo_6.png'>";
// echo "<img src='photo_7.png'>";
// echo "<img src='photo_8.png'><br />";
// echo "<img src='photo_9.png'>";
$dst_im	= array("0"=>$dst_im0,
				"1"=>$dst_im1,
				"2"=>$dst_im2,
				"3"=>$dst_im3,
				"4"=>$dst_im4,
				"5"=>$dst_im5,
				"6"=>$dst_im6,
				"7"=>$dst_im7,
				"8"=>$dst_im8,
				"9"=>$dst_im9,
				);
//$dst_im=@imagecreatefrompng("9.png");

	return $dst_im;
}
function true_pw($input,$im){
	$input_pw=str_split($input);
	//var_dump($input_pw);
	$result= get_img($im);
	$pw = array();
	$temp=1;
	//echo "<br>==========================================<br>";
	foreach ($result as $key => $value) {
		$pw[$key] = imagepgm($value);
		//echo $pw[$key];
		if ($temp%3==0) {
			//echo "<br>";
		}
		$temp++;
	}
	//echo "<br>==========================================<br>";
	$output='';
	foreach ($input_pw as $value) {
		foreach ($pw as $key => $value1) {
			if ($value == $value1) {
				$output .= $key;
			}
		}
	}
	//print_r($output);
	return $output;
}
function final_card($uid,$userpw){
	$cookie_jar = tempnam('./tmp','JSESSIONID'); 
	$ch = curl_init("http://card.jnu.edu.cn:8080/getpasswdPhoto.action");
	 
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true) ; // 获取数据返回  
	curl_setopt($ch, CURLOPT_BINARYTRANSFER, true) ; // 在启用 CURLOPT_RETURNTRANSFER 时候将获取数据返回 
	curl_setopt($ch, CURLOPT_COOKIEJAR, $cookie_jar); 
	$output = curl_exec($ch);
	$im=imagecreatefromstring($output);
	$pw_final=true_pw($userpw,$im);
	//print_r($cookie_jar);
	curl_close($ch);
	//echo "================================================================<br>";
	$cookie_jar2 = tempnam('./tmp','JSESSIONID'); 
	$ch = curl_init("http://card.jnu.edu.cn:8080/getCheckpic.action?rand=1234.11111111111111111") ; 
	curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie_jar);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); // 获取数据返回
	curl_setopt($ch, CURLOPT_BINARYTRANSFER, true); // 在启用 CURLOPT_RETURNTRANSFER 时候将获取数据返回
	curl_setopt($ch, CURLOPT_COOKIEJAR, $cookie_jar2); 
	$output1 = curl_exec($ch);

	//print_r($cookie_jar2);
	curl_close($ch);
	//echo "================================================================<br>";
	$cookie_jar3 = tempnam('./tmp','JSESSIONID');
	$url = "http://card.jnu.edu.cn:8080/loginstudent.action";
	$post_data = array(
		"name"=>$uid,
		"loginType"=>"1",
		"passwd"=>$pw_final,
		"rand"=>"1234",
		"userType"=>"1",
		);
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $url);
	curl_setopt($ch, CURLOPT_HEADER, false);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	// post数据
	curl_setopt($ch, CURLOPT_POST, 1);
	// post的变量
	curl_setopt($ch, CURLOPT_POSTFIELDS, $post_data);
	curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie_jar);
	curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie_jar2);
	curl_setopt($ch, CURLOPT_COOKIEJAR, $cookie_jar3); 
	$output2 = curl_exec($ch);
	curl_close($ch);
	//打印获得的数据
	//echo "================================================================<br>";
	//print_r($output2);

	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, "http://card.jnu.edu.cn:8080/accountcardUser.action");
	curl_setopt($ch, CURLOPT_HEADER, false);
	curl_setopt($ch, CURLOPT_HEADER, 0);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);        
	curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie_jar3);
	$output3 = curl_exec($ch);
	//echo $output3;
	curl_close($ch);
	return $output3;
}
function cdkey(){
	$flag = false;
	$cdkey = array('admin','jnucard',);
	if (isset($_GET['key'])) {
		foreach ($cdkey as $value) {
			if ($value == $_GET['key']) {
				$flag = true;
			}
		}
	}
	return $flag;
}
function get_money(){
	//include 'simple_html_dom.php';
	$final = array();
	if (isset($_GET['userid'])) {
		if (cdkey() == true) {
			$html = new simple_html_dom();
			$html->load(final_card($_GET['userid'],$_GET['userpw']));
			$content=array();
			$k=0;
			foreach($html->find('td[class=neiwen]') as $post)
			{
			     $content[$k]=strip_tags($post);
			     $k++;
			}
			//echo "姓名：".$content[1]."=>账号：".$content[3]."=>余额：".$content[46].":-D";
			$arr=explode('（',$content[46]);
			$money=$arr[0];
			$final = array(
							"name" => trim($content[1]),
							"card_id" => trim($content[3]),
							"money" => trim($money),
				);		
			$html->clear();
		}
	}else{
		echo "account error";
	}
	return $final;
}
echo json_encode(get_money()); 
?>
